\documentclass[tikz,border=5pt]{standalone}
\usepackage{amsmath}
\usetikzlibrary{arrows.meta,3d}
\usepackage{tikz-3dplot}

% Styles and macros: centralize definitions to reduce repetition and preserve visuals
\tikzset{
    edge visible/.style={gray,thin},
    edge hidden/.style={gray,thin,dashed},
    gridnode/.style={circle,fill=black,minimum size=4pt,inner sep=0pt},
    centernode/.style={circle,fill=green!60!black,minimum size=6pt,inner sep=0pt},
    dirarrow/.style={gray,->,line width=2pt,opacity=0.7},
    dirarrowfaint/.style={gray,->,line width=2pt,opacity=0.3},
    weightlabel/.style={blue,anchor=north east},
    dirnum/.style={red,font=\footnotesize},
    axisarrow/.style={black,->,line width=0.8pt},
    axisarrowX/.style={red!80!black,->,line width=0.9pt},
    axisarrowY/.style={green!60!black,->,line width=0.9pt},
    axisarrowZ/.style={blue!70!black,->, line width=0.9pt}
}

% Utility macros: reduce repetition and keep anchors/styles consistent
% Batch place weights for two index groups (odd/even)
% Args: #1 odd index list, #2 even index list, #3 math content, #4 odd anchor, #5 even anchor
\newcommand{\PlaceWeights}[5]{%
    \foreach \i in #1 {\node[weightlabel,anchor=#4,yshift=1.5pt] at (P\i) {#3};}%
    \foreach \i in #2 {\node[weightlabel,anchor=#5,yshift=1.5pt] at (P\i) {#3};}%
}

% Batch place direction numbers by prefix (for main P and inset Q)
% Args: #1 odd index list, #2 even index list, #3 coordinate prefix (P or Q)
\newcommand{\PlaceDirNumsAt}[3]{%
    \foreach \i in #1 {\node[dirnum,anchor=south west] at (#3\i) {\i};}%
    \foreach \i in #2 {\node[dirnum,anchor=south east] at (#3\i) {\i};}%
}

% Direction list: consistent with original figure
\def\DIRECTIONS{
    1/0/0, -1/0/0, 0/1/0, 0/-1/0, 0/0/1, 0/0/-1,
    1/1/0, -1/1/0, 1/-1/0, -1/-1/0,
    1/0/1, -1/0/1, 1/0/-1, -1/0/-1,
    0/1/1, 0/-1/1, 0/1/-1, 0/-1/-1,
    1/1/1, -1/1/1, 1/-1/1, -1/-1/1,
    1/1/-1, -1/1/-1, 1/-1/-1, -1/-1/-1
}

% Index groups: unify weight labels, arrow styles, and number anchors (no visual change)
% Note: TeX control sequence names use letters only; avoid underscores causing parsing issues
% faces: 1..6; edges: 7..18; corners: 19..26
\def\IDXFACESODD{1,3,5}
\def\IDXFACESEVEN{2,4,6}
\def\IDXEDGESODD{7,9,11,13,15,17}
\def\IDXEDGESEVEN{8,10,12,14,16,18}
\def\IDXCORNERSODD{19,21,23,25}
\def\IDXCORNERSEVEN{20,22,24,26}
% x=0 plane (strong arrows) vs others (faint arrows)
\def\IDXXZERO{3,4,5,6,15,16,17,18}
\def\IDXEXPLODED{1,2,7,8,9,10,11,12,13,14,19,20,21,22,23,24,25,26}
% Odd/even index sets (for number anchoring)
\def\IDXALLODD{1,3,5,7,9,11,13,15,17,19,21,23,25}
\def\IDXALLEVEN{2,4,6,8,10,12,14,16,18,20,22,24,26}

% Horizontal slice spacing (horizontal distance after projection)
\def\slicegap{1.0}

\begin{document}
    % Main view (to use tikz-3dplot projection, enable next line and add tdplot_main_coords to tikzpicture options)
    %\tdplotsetmaincoords{70}{120}
    \begin{tikzpicture}[scale=2.5,>=Stealth]

    % draw the three x-planes as separate 3x3 grids
    \foreach \xp in {-1,0,1} {
        \pgfmathsetmacro{\dx}{\slicegap*\xp}
        \begin{scope}[shift={(\dx,0)}]
            % plane frame at x=\xp
            \draw[edge visible] (\xp,-1,-1) -- (\xp, 1,-1) -- (\xp, 1, 1) -- (\xp,-1, 1) -- cycle;
            % 9 grid nodes for this slice
            \foreach \y in {-1,0,1} {
                \foreach \z in {-1,0,1} {
                    \node[gridnode] at (\xp,\y,\z) {};
                }
            }
        \end{scope}
    }

    % center node (remains in the middle slice, unshifted)
    \node[centernode] (centerX) at (0,0,0) {};

    % create named endpoints for all 26 directions with per-slice horizontal shift
    \foreach [count=\i from 1] \x/\y/\z in \DIRECTIONS {
        \pgfmathsetmacro{\dx}{\slicegap*\x}
        \begin{scope}[shift={(\dx,0)}]
            \coordinate (P\i) at (\x,\y,\z);
        \end{scope}
    }

    % arrows from the center to each endpoint
    % strong arrows to same x-slice (x=0)
    \foreach \i in \IDXXZERO {\draw[dirarrow] (centerX) -- (P\i);}    
    % lighter arrows to exploded slices (x=±1)
    \foreach \i in \IDXEXPLODED {\draw[dirarrowfaint] (centerX) -- (P\i);}    

    % all weights (placed with opposite anchors to direction numbers to avoid overlap)
    % center
    \node[weightlabel] at (0,0,0) {$\frac{8}{27}$};

    % face centers (6) -> 2/27
    \PlaceWeights{\IDXFACESODD}{\IDXFACESEVEN}{$\frac{2}{27}$}{north east}{north west}

    % edges (12) -> 1/54
    \PlaceWeights{\IDXEDGESODD}{\IDXEDGESEVEN}{$\frac{1}{54}$}{north east}{north west}

    % corners (8) -> 1/216
    \PlaceWeights{\IDXCORNERSODD}{\IDXCORNERSEVEN}{$\frac{1}{216}$}{north east}{north west}

    % direction numbers (0-26)
    \node[dirnum,anchor=south east] at (0,0,0) {0};
    % Keep odd/even anchor grouping consistent with original: odd SW, even SE
    \PlaceDirNumsAt{\IDXALLODD}{\IDXALLEVEN}{P}

    % title
    \node[font=\Large] at (0,-2,0) {D3Q27};

    % =====================
    % Inset: full cube view
    % =====================
    % Place smaller overall cube centered above the exploded layout (closer vertically)
    \begin{scope}[shift={(0.75,2.5)}, scale=0.55]
        % Cube frame
        \draw[edge hidden] (-1,-1,-1) -- (1,-1,-1);
        \draw[edge hidden] (-1,-1,-1) -- (-1,1,-1);
        \draw[edge hidden] (-1,-1,-1) -- (-1,-1,1);
        \draw[edge visible] (1,-1,-1) -- (1,1,-1) -- (-1,1,-1) -- (-1,-1,-1);
        \draw[edge visible] (1,-1,-1) -- (1,-1,1) -- (1,1,1) -- (1,1,-1);
        \draw[edge visible] (1,-1,1) -- (-1,-1,1) -- (-1,1,1) -- (1,1,1);
        \draw[edge visible] (-1,1,-1) -- (-1,1,1);
        \draw[edge visible] (-1,-1,1) -- (1,-1,1);
        \draw[edge visible] (1,1,-1) -- (1,1,1);

        % 3x3x3 grid nodes
        \foreach \x in {-1,0,1} {
            \foreach \y in {-1,0,1} {
                \foreach \z in {-1,0,1} {
                    \node[gridnode] at (\x,\y,\z) {};
                }
            }
        }

        % Central green node (0,0,0)
        \node[centernode] (center) at (0,0,0) {};

        % 26 non-center direction endpoints (Q1..Q26) with arrows
        \foreach [count=\i from 1] \x/\y/\z in \DIRECTIONS {
            \coordinate (Q\i) at (\x,\y,\z);
            \draw[dirarrow] (center) -- (Q\i);
        }

    % Representative weights (omitted in inset to avoid clutter)

    % Direction numbers 0–26 (odd SW / even SE)
        \node[dirnum,anchor=south east] at (0,0,0) {0};
    \PlaceDirNumsAt{\IDXALLODD}{\IDXALLEVEN}{Q}

        % Axes: placed to the left of the cube, indicating x,y,z directions
    \coordinate (A0) at (-3.15,-0.35,-0.35);
    \draw[axisarrowX] (A0) -- ++(0.9,0,0) node[anchor=west, text=red!80!black] {$x$};
    \draw[axisarrowY] (A0) -- ++(0,0.9,0) node[anchor=south, text=green!60!black] {$y$};
    \draw[axisarrowZ] (A0) -- ++(0,0,0.9) node[anchor=south east, text=blue!70!black] {$z$};

        % Subtitle (kept hidden to avoid crowding)
        % \node[font=\large] at (0,-2,0) {D3Q27};
    \end{scope}

\end{tikzpicture}
\end{document}
